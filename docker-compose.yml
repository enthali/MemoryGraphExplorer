# Production docker-compose: Consolidated single container
# Runs both MCP Server and Web UI in one container

name: memorygraphexplorer

services:
  memory-graph-explorer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: memory-graph-explorer
    ports:
      - "8080:8080"  # Production: Web UI on host port 8080 (MCP internal on 3000)
    volumes:
      # Mount the memory.json file from its current location
      - C:/workspace/Journal/memory.json:/app/data/memory.json
    environment:
      - NODE_ENV=production
      - FLASK_ENV=production
      - MEMORY_FILE_PATH=/app/data/memory.json
      - MCP_SERVER_PORT=3000
      - WEB_UI_PORT=8080
      - MCP_SERVER_URL=http://localhost:3000/mcp
      - MCP_PROXY_INTERNAL_URL=http://localhost:3000/mcp
      - AUTH_ENABLED=true
      # Set API_KEYS via environment variable or secrets management:
      # Format: "key:name:permissions|key2:name2:perms"
      # Example: "prod-key-abc:Copilot:read,write|admin-key-xyz:Admin:read,write,admin"
      - API_KEYS=${API_KEYS:-}
    restart: unless-stopped
    healthcheck:
      # Use root endpoint for health check (serves static files, no auth needed)
      # API health endpoint requires authentication: /api/health
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

